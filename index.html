<!doctype html>
<html lang='en'>
<head>
  <meta charset="utf-8">
  <!-- <meta name="viewport" content="width=640px, user-scalable=no"> -->
  <title>Cat Tunnel</title>
  <script src="js/helper.js"></script>
  <style>
  /*input, textarea {
  -webkit-appearance: none;
  -webkit-border-radius: 0;
}*/
  button {
    background-color: grey;
    border-radius: 8px;
  }

  #container {
    background-color: black;
  }

  canvas {
    background-image: url(res/stars.gif);
    display: block;
    position: absolute;
    margin: auto;
    margin-top: 30px;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
  </style>
</head>
<body>
  <script>
    var screen, input, frames, spFrame;
    var catSprite, myScore;
    var rainbowRoad, outsideRoad;
    var yCounter, halfGap;

    function mainGame() {
      screen = new Screen(480, 640);
      input = new InputHandler();

      var img = new Image();
      img.addEventListener("load", function() {
        catSprite = new Sprite(this, 0, 0, 77, 49);
        init();
        run();
      });
      img.src = "res/hackGSU_RainbowCatRun.png";
    };

    function init() {
      frames = 0;
      spFrame = 0;

      player = {
        sprite: catSprite,
        x: (screen.width - catSprite.w) / 2,
        y: screen.height - (30 + catSprite.h),
        w: catSprite.w,
        h: catSprite.h,
        health: 1
      }

      rainbowRoad = [];
      outsideRoad = [];
    };

    function run() {
      console.log("Game Running!");
      var loop = function() {
        update();
        render();
        window.requestAnimationFrame(loop, screen.canvas);
      };
      window.requestAnimationFrame(loop, screen.canvas);
    };

    function update() {

      if (input.isDown(37)) { //LEFT
        player.x -= 8;
      }
      if (input.isDown(39)) { //RIGHT
        player.x += 8;
      }
      if (input.isDown(40)) { //UP
        player.y += 8;
      }
      if (input.isDown(38)) { //DOWN
        player.y -= 8;
      }

      //Generate the rainbowRoad
      if (frames % 60 === 0 || frames === 0) {
        yCounter = 0;
        halfGap = Math.random() * (70 - 50) + 50;

        //for first cycle
        if (frames === 0) {
          //center part
          rainbowRoad.push(new Rainbow((screen.width / 2) - halfGap, yCounter, (screen.width / 2) - halfGap, 100, "#800080"));
          // //right part
          // rainbowRoad.push(new Rainbow(halfGap + (screen.width / 2), yCounter, (screen.width / 2) - halfGap, 30, "#800080"));
        }
        else {
          //updating and repacling old array values
          for (var i = 0, len = rainbowRoad.length; i <= len; i++) {
          if(rainbowRoad[i].y === yCounter) {
            //replace at center
            rainbowRoad[i] = new Rainbow((screen.width / 2) - halfGap, yCounter, (screen.width / 2) - halfGap, 100, "#800080");
            //replace at right
            // rainbowRoad[i+1] = new Rainbow(halfGap + (screen.width / 2), yCounter, (screen.width / 2) - halfGap, 30, "#800080");
            break;
            }
          }
        }
      }
        if (frames % 5 === 0 && frames % 60 !== 0) {
          yCounter += 53.3;
          halfGap = Math.random() * (70 - 50) + 50;

          if (frames <= 60) {
            //center part
            rainbowRoad.push(new Rainbow((screen.width / 2) - halfGap, yCounter, (screen.width / 2) - halfGap, 100, "#800080"));
            // //right part
            // rainbowRoad.push(new Rainbow(halfGap + (screen.width / 2), yCounter, (screen.width / 2) - halfGap, 30, "#800080"));
          }
          else {
          //updating and repacling old array values
          for (var i = 0, len = rainbowRoad.length; i <= len; i++) {
          if(rainbowRoad[i].y === yCounter) {
            //replace at center
            rainbowRoad[i] = new Rainbow((screen.width / 2) - halfGap, yCounter, (screen.width / 2) - halfGap, 100, "#800080");
            //replace at right
            // rainbowRoad[i+1] = new Rainbow(halfGap + (screen.width / 2), yCounter, (screen.width / 2) - halfGap, 30, "#800080");
            break;
            }
          }
         }
        }


        //GAME OVER if Player get hit!
        for (var i = 0, len = rainbowRoad.length; i < len; i++) {
          var r = rainbowRoad[i];
        if ((AABBIntersect(r.x, r.y, r.width, r.height, player.x, player.y, player.w, player.h)) && frames >= 100 && frames % 60 === 0) {
          player.health -= 1;
          console.log('You are dead!:' + player.health);
            // break;
          }
          else {
            console.log('You are safe!:' + player.health);
          }
            }
        if (player.health <= 0) {
          //activate the endgame function
        }


      // HOW TO CHANGE THE WIDTH OF THE RAINBOW ROAD AND CYCLE IT
      // if (frames % lvFrame === 0){
      //   spFrame = (spFrame + 1) % 2;
      //
      //   var max_ = 0, min_ = screen.width;
      //   for (var i = 0, len = aliens.length; i < len; i++) {
      //     var a = aliens[i];
      //     a.x += 30 * dir;
      //
      //     max_ = Math.max(max_, a.x + a.w);
      //     min_ = Math.min(min_, a.x);
      //   }
      //
      //   if (max_ > screen.width -30 || min_ < 30) {
      //     dir *= -1;
      //     for (var i = 0, len = aliens.length; i < len; i++) {
      //       aliens[i].x += 30 * dir;
      //       aliens[i].y += 30;
      //     }
      //   }
      // }
      frames++;
      console.log(frames);
    };

    function render() {
      screen.clear();
      screen.ctx.save();
      for (var i = 0, len = rainbowRoad.length; i < len; i++) {
        screen.drawRainbow(rainbowRoad[i]);
      }
      screen.ctx.restore();

      screen.drawSprite(player.sprite, player.x, player.y);
    };

    mainGame();


  </script>
  <!-- <embed loop="true" src="res/awesome_8bit.mp3" hidden="true" type="audio/mp3"></embed> -->
</body>
</html>
